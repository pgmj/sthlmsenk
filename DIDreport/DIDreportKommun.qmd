---
title: "Data i dialog"
subtitle: "Kommunrapport Vallentuna"
title-block-banner: "#009ca6"
title-block-banner-color: "#FFFFFF"
author: 
  name: Magnus Johansson
  affiliation: RISE Research Institutes of Sweden
  affiliation-url: https://www.ri.se/sv/vad-vi-gor/expertiser/kategoriskt-baserade-matningar
  orcid: 0000-0003-1669-592X
date: '2023-01-23'
format: 
  html:
    toc: true
    toc-depth: 3
    toc-title: "Innehållsförteckning"
    embed-resources: true
    standalone: true
    page-layout: full
    logo: rise_logo_quarto.png
    mainfont: 'Lato'
    monofont: 'Roboto Mono'
    code-overflow: wrap
    code-tools: false
    code-fold: false
    number-sections: true
    fig-dpi: 150
    layout-align: left
    linestretch: 1.6
    theme: materia
    link-external-newwindow: true
  pdf:
    papersize: a4
    documentclass: article #article, report or book
    classoption: [twocolumn, portrait]
  revealjs:
    theme: default
    logo: rise_logo_quarto.png
    chalkboard: false
    self-contained: true
    footer: 'Material skapat av magnus.p.johansson@ri.se'
    mainfont: 'Lato'
    slide-level: 4
    scrollable: true
    smaller: false
  docx:
    toc: true
    number-sections: true
    title: "Rasch in Quarto"
    subtitle: "Template file"
    author: "Magnus Johansson"
#    reference-doc: RISEmallMJv6.dotx
execute:
  echo: false
  warning: false
  message: false
  cache: true
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: inline
---

```{r}

# which municipality to focus this report on?
fokusKommun <- "Vallentuna"

# which municipalities should be included in comparisons?
jmfKommun <- c(fokusKommun,"Vaxholm","Täby","Danderyd")

# years of interest
years <- c(2016,2018,2020,2022)

# setup -------------------------------------------------------------------
library(ggeffects)
library(ggplot2)
library(tidyverse)
library(shiny)
library(arrow)
library(xlsx)

library(ggdist) # for shadeable density slabs
library(gghalves) # for half-half geoms
library(ggpp) # for position_dodge2nudge %>% 
library(colorspace) # for lightening color palettes
library(extrafont) # for Lato, RISE font
library(stringr)
library(EnvStats)
library(bslib)
library(formattable)
library(thematic)
library(catR)
library(Hmisc)

library(geomtextpath)
library(readxl)
library(rlang)
library(visNetwork)
library(networkD3)
library(RColorBrewer)
library(vctrs)
library(ggiraph)
library(gt)
library(gtExtras)

### some commands exist in multiple packages, here we define preferred ones that are frequently used
select <- dplyr::select
count <- dplyr::count
recode <- car::recode
rename <- dplyr::rename

### text sizes
ax.size <- 10
title.size <- 12
legend.size <- 10
stript.size <- 10
årtal <- c(2006,2008,2010,2012,2014,2016,2018,2020,2022)


### set up color palette based on RISE guidelines
RISEprimGreen <- "#009ca6"
RISEprimRed <- "#e83c63"
RISEprimYellow <- "#ffe500"
RISEprimGreenMid <- "#8dc8c7"
RISEprimRedMid <- "#f5a9ab"
RISEprimYellowMid <- "#ffee8d"
RISEprimGreenLight <- "#ebf5f0"
RISEprimRedLight <- "#fde8df"
RISEprimYellowLight <- "#fff7dd"
RISEcompPurple <- "#482d55"
RISEcompGreenDark <- "#0e4e65"
RISEgrey1 <- "#f0f0f0"
RISEgrey2 <- "#c8c8c8"
RISEgrey3 <- "#828282"
RISEgrey4 <- "#555555"

### colors specifically for DID application
DIDcolorsOriginal <- c('#D55E00','#F0E442','#009E73','#999999')
DIDcolors <- lighten(DIDcolorsOriginal, amount = 0.1, space = "HLS")
DIDred <- "#D55E00"
DIDorange <- "#E69F00"
DIDgreen <- "#009E73"
DIDyellow <- "#F0E442"

RISEpalette1 <- colorRampPalette(colors = c("#009ca6", "#e83c63", "#ffe500"))(6)
#scales::show_col(RISEpalette1)

RISEpalette2 <- colorRampPalette(colors = c("#009ca6", "#482d55", "#e83c63", "#ffe500"))(8)
#scales::show_col(RISEpalette2)

# distance between panels in faceted ggplots
pandist <- 0.6

rfactors <- c('Utagerande','Närsamhälle','Föräldraskap','Psykiska/ psykosomatiska besvär','Vantrivsel i skolan')
pfactors <- c('Välbefinnande','Positiv skolanknytning')

```

```{r}
# read data

# Import data -------------------------------------------------------------

## Stockholmsenkäten --------------------------------------
df <- read_parquet("../../DIDapp/data/2023-01-23_ScoredRev.parquet")
df <- df %>%
 rename(Kommun = DIDkommun)

df <- df %>% 
  filter(Kommun %in% jmfKommun)

# remove data from before 2006 for Södertälje, due to lack of comparisons
df <- df %>% 
  filter(!ar < 2006)

# define demographic variables of interest
demogr.vars<-read.csv("../../DIDapp/data/SthlmsEnk_demographicVariables.csv")
demogr.vars <- demogr.vars$demogr.vars

# final set of items based on psychometric analyses
itemlabels.final <- read_excel("../../DIDapp/data/SthlmsEnk_allItemInfo_2022-12-06.xls") %>% 
  select(itemnr,item,Index)

# list of all items included in analyses (even those discarded)
allitems <- read.csv("../../DIDapp/data/SthlmsEnk_allitems.csv")

# list of item responses for Psykiska/ psykosomatiska besvär, for use in the "persona" visualization
itemresponses <- read.xlsx("../../DIDapp/data/SthlmsEnk_04psfRespCats.xls", sheetName = "04psf")

# create vector with all index names
sthlm.index <- itemlabels.final %>% 
  distinct(Index) %>% 
  pull()

## Skolinspektionen --------------------------------------------------------

# read data from processed file with Rasch based scores
#df.si <- read_parquet("../../DIDapp/data/SkolinspÅk5Scored.parquet")
# this data is also based on higher score = higher risk

# some functions are based on the SthlmsEnkät labeling of year as "ar"
# we add a duplicate year variable
# df.si <- df.si %>% 
#   mutate(ar = as.numeric(as.character(År)),
#          ar = vec_cast(ar, double()))
# 
# # read item info
# si.items <- read_csv("../../DIDapp/data/SkolinspFinalItems.csv")
# note that all SI items have merged the top 3 response categories (top = highest risk)

# Cutoff values SthlmsEnk -------------------------------------------------------------

# percentiles based on 2006-2020 data for all of Stockholm Stad (~ 110k responses)
# each year's 70th and 90th percentile value was used to calculate an average (not weighted in any way)
# see script "file 04 Distributions and risk limits.R" in https://github.com/pgmj/sthlmsenk/tree/main/OtherScripts
#rslimits <- read.csv("../../DIDapp/data/SthlmsEnk_rslimitsNoRev2022-12-06.csv")
rslimits <- read_csv("../../DIDapp/data/2023-01-17_rslimitsRisk.csv")

# read cutoffs for protective factors
#rslimits.prot <- read_csv("data/2022-12-16_protective.csv")
rslimits.prot <- read_csv("../../DIDapp/data/2023-01-17_rslimitsProt.csv")

rslimits <- cbind(rslimits,rslimits.prot)
rslimits <- rslimits %>% 
  relocate(SkolaPositiv, .after = SkolaNegativ)

# for Skolinspektionen ÅK5
#rslimits.si <- read_csv("../../DIDapp/data/SkolinspRSlimitsNoRev.csv")
#rslimits$`Positiv skolanknytning åk 5` <- rslimits.si$`Positiv skolanknytning`

```

```{r}

# define a vector with all municipalities included in the dataset, to be used in input selection lists
# kommuner <- df %>%
#   distinct(Kommun) %>% 
#   pull()

# vector of years to be included in year selection inputs
årtal <- c(2006,2008,2010,2012,2014,2016,2018,2020,2022)

rsfaktorer <- c('Utagerande','Närsamhälle','Föräldraskap','Psykiska/ psykosomatiska besvär','Vantrivsel i skolan','Positiv skolanknytning','Välbefinnande')

#---- sums.index -> key metrics for each year and municipality----

RSsmf <- function(df, i, j) { # input df, index, and index number
  #j <- match(qc({{i}}),sthlm.index)
  df %>% 
    group_by(ar,Kommun) %>% 
    summarise(Medel = mean({{i}}, na.rm = T),
              StDev = sd({{i}},  na.rm = T),
              n = n(),
              StErr = StDev/sqrt(n),
              sd.lo = Medel-StDev,
              sd.hi = Medel+StDev,
              n.90 = length(which({{i}} > rslimits[2,j]))/n*100,
              n.75 = length(which({{i}} > rslimits[1,j]))/n*100) %>% 
    rename(År = ar) %>% 
    mutate(across(where(is.numeric), round, 3)) %>% 
    as.data.frame()
}  

sums.Utagerande <- RSsmf(df, Utagerande, 1) %>% 
  add_column(Faktor = 'Utagerande')
sums.SkolaNegativ <- RSsmf(df, SkolaNegativ, 2) %>% 
  add_column(Faktor = 'SkolaNegativ')
sums.SkolaPositiv <- RSsmf(df, SkolaPositiv, 3) %>% 
  add_column(Faktor = 'SkolaPositiv')
sums.PsykSomBesv <- RSsmf(df, PsykSomBesv, 4) %>% 
  add_column(Faktor = 'PsykSomBesv')
sums.Parenting <- RSsmf(df, Parenting, 5) %>% 
  add_column(Faktor = 'Parenting')
sums.Community <- RSsmf(df, Community, 6) %>% 
  add_column(Faktor = 'Community')
sums.Wellbeing <- RSsmf(df, Wellbeing, 7) %>%
 add_column(Faktor = 'Wellbeing')

sums.index <- rbind(sums.Utagerande,
                    sums.SkolaPositiv,
                    sums.SkolaNegativ,
                    sums.PsykSomBesv,
                    sums.Parenting,
                    sums.Community,
                    sums.Wellbeing)

# same but for Skolinspektionens data
# sums.Skolinsp <- RSsmf(df.si,Indexvärde, 8) %>%
#   add_column(Faktor = 'SkolaPositivSI')

## get key values divided by gender----

RSsmfGender <- function(df, i, j) { # input df, index, and index number
  #j <- match(qc({{i}}),sthlm.index)
  df %>% 
    group_by(ar,Kommun,Kön) %>% 
    summarise(Medel = mean({{i}}, na.rm = T),
              StDev = sd({{i}},  na.rm = T),
              n = n(),
              StErr = StDev/sqrt(n),
              sd.lo = Medel-StDev,
              sd.hi = Medel+StDev,
              n.90 = length(which({{i}} > rslimits[2,j]))/n*100,
              n.75 = length(which({{i}} > rslimits[1,j]))/n*100) %>% 
    rename(År = ar) %>% 
    mutate(across(where(is.numeric), round, 3)) %>% 
    as.data.frame()
}  

sums.Utagerande <- RSsmfGender(df, Utagerande, 1) %>% 
  add_column(Faktor = 'Utagerande') %>% 
  filter(!Kön == '<NA>')
sums.SkolaPositiv <- RSsmfGender(df, SkolaPositiv, 2) %>% 
  add_column(Faktor = 'SkolaPositiv') %>% 
  filter(!Kön == '<NA>')
sums.SkolaNegativ <- RSsmfGender(df, SkolaNegativ, 3) %>% 
  add_column(Faktor = 'SkolaNegativ') %>% 
  filter(!Kön == '<NA>')
sums.PsykSomBesv <- RSsmfGender(df, PsykSomBesv, 4) %>% 
  add_column(Faktor = 'PsykSomBesv') %>% 
  filter(!Kön == '<NA>')
sums.Parenting <- RSsmfGender(df, Parenting, 5) %>% 
  add_column(Faktor = 'Parenting') %>% 
  filter(!Kön == '<NA>')
sums.Community <- RSsmfGender(df, Community, 6) %>% 
  add_column(Faktor = 'Community') %>% 
  filter(!Kön == '<NA>')
sums.Wellbeing <- RSsmfGender(df, Wellbeing, 7) %>%
  add_column(Faktor = 'Wellbeing') %>%
  filter(!Kön == '<NA>')

sums.indexG <- rbind(sums.Utagerande,
                     sums.SkolaPositiv,
                     sums.SkolaNegativ,
                     sums.PsykSomBesv,
                     sums.Parenting,
                     sums.Community,
                     sums.Wellbeing)

# same but for Skolinspektionens data
# sums.SkolinspG <- RSsmfGender(df.si,Indexvärde, 8)%>%
#   add_column(Faktor = 'SkolaPositivSI')


## merge sums.index files----

sums.index <- sums.index %>%
  add_column(Kön = "Flickor och pojkar")

sums.indexG <- sums.indexG %>%
  relocate(Kön, .after = "Faktor")

sums.index <- rbind(sums.index, sums.indexG)

# same but for Skolinspektionens data
# sums.si <- sums.Skolinsp %>%
#   add_column(Kön = "Flickor och pojkar")
# sums.SkolinspG <- sums.SkolinspG %>%
#   relocate(Kön, .after = "Faktor")
# sums.si <- rbind(sums.si, sums.SkolinspG)
# sums.si <- sums.si %>% 
#   mutate(ar = as.numeric(as.character(År)))

# Create risk-level variable -------------------------------------------------

RSrisklevel <- function(df, i) { # input df, index, and index number
  df |>
    mutate(
      !!paste0("Risk",i) := case_when(
        .data[[i]] < rslimits |> select(i) |> slice(1) |> pull() ~ "Låg risk",
        .data[[i]] >= rslimits |> select(i) |> slice(1) |> pull()
        & .data[[i]] < rslimits |> select(i) |> slice(2) |> pull() ~ "Medelhög risk",
        .data[[i]] >= rslimits |> select(i) |> slice(2) |> pull() ~ "Hög risk")
      ) |>
    select(!!paste0("Risk",i))
}

# Rename RS-factors -------------------------------------------------------

sums.index$Faktor <- car::recode(sums.index$Faktor,"'Community'='Närsamhälle';
                                 'Parenting'='Föräldraskap';
                                 'PsykSomBesv'='Psykiska/ psykosomatiska besvär';
                                 'SkolaNegativ'='Vantrivsel i skolan';
                                 'Wellbeing'='Välbefinnande';
                                 'SkolaPositiv'='Positiv skolanknytning'")

df <- df %>% 
  rename(Närsamhälle = Community,
         Föräldraskap = Parenting,
         'Psykiska/ psykosomatiska besvär' = PsykSomBesv,
         'Vantrivsel i skolan' = SkolaNegativ,
         Välbefinnande = Wellbeing,
         'Positiv skolanknytning' = SkolaPositiv
  )

rslimits <- rslimits %>% 
  rename(Närsamhälle = Community,
         Föräldraskap = Parenting,
         'Psykiska/ psykosomatiska besvär' = PsykSomBesv,
         'Vantrivsel i skolan' = SkolaNegativ,
         Välbefinnande = Wellbeing,
         'Positiv skolanknytning' = SkolaPositiv
  )

#rslimits.prot <- read_csv("../../DIDapp/data/2022-12-16_protective.csv")
rslimits.prot <- read_csv("../../DIDapp/data/2023-01-17_rslimitsProt.csv")

rslimits.prot <- rslimits.prot %>% 
  rename(Välbefinnande = Wellbeing,
         'Positiv skolanknytning' = SkolaPositiv
  )


# Create long format risklevel df ------------------------
#for coord_polar plot. Might be able to replace others
riskCalc <- function(df,index){
  df %>% 
    mutate(riskLevel = case_when(
      .data[[index]] < rslimits |> select(index) |> slice(1) |> pull() ~ "Låg risk",
      .data[[index]] >= rslimits |> select(index) |> slice(1) |> pull() & 
        .data[[index]] < rslimits |> select(index) |> slice(2) |> pull() ~ "Medelhög risk",
      .data[[index]] >= rslimits |> select(index) |> slice(2) |> pull() ~ "Hög risk")
    ) %>% 
    group_by(Kommun,ar)  %>%  
    count(riskLevel) %>% 
    mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>%  
    mutate(riskLevel = factor(riskLevel, levels = c('Hög risk','Medelhög risk','Låg risk','NA'))) %>% 
    ungroup() %>% 
    add_column(Index = as.character(index)) %>% 
    mutate(År = as.factor(ar)) %>%
    select(!all_of(c("n","ar")))
}

df.risk <- data.frame(matrix(ncol = 4, nrow = 0))
for (i in rsfaktorer){
  df.r1<-as.data.frame(riskCalc(df,i))
  df.risk <- rbind(df.risk,df.r1)
}

riskCalcGender <- function(df,index){
  df %>% 
    mutate(riskLevel = case_when(
      .data[[index]] < rslimits |> select(index) |> slice(1) |> pull() ~ "Låg risk",
      .data[[index]] >= rslimits |> select(index) |> slice(1) |> pull() & 
        .data[[index]] < rslimits |> select(index) |> slice(2) |> pull() ~ "Medelhög risk",
      .data[[index]] >= rslimits |> select(index) |> slice(2) |> pull() ~ "Hög risk")
    ) %>% 
    group_by(Kommun,ar,Kön)  %>%  
    count(riskLevel) %>% 
    mutate(Andel = (100 * n / sum(n)) %>% round(digits = 2)) %>%  
    mutate(riskLevel = factor(riskLevel, levels = c('Hög risk','Medelhög risk','Låg risk','NA'))) %>% 
    ungroup() %>% 
    add_column(Index = as.character(index)) %>% 
    mutate(År = as.factor(ar)) %>%
    filter(!Kön == "<NA>") %>% 
    select(!all_of(c("n","ar")))
}

df.risk.gender <- data.frame(matrix(ncol = 4, nrow = 0))
for (i in rsfaktorer){
  df.r1<-as.data.frame(riskCalcGender(df,i))
  df.risk.gender <- rbind(df.risk.gender,df.r1)
}

```

## Demografi

För att se exakta antal i figurerna går det att använda muspekaren på respektive punkt.

::: panel-tabset
### Fördelat på kön
```{r}
responsesGender <- df %>% 
  filter(Kommun == fokusKommun,
         !Kön == "<NA>") %>% 
  rename(År = ar,
         Årskurs = ARSKURS) %>% 
  group_by(År,Kön) %>% 
  summarise(Antal = n()) %>% 
  ggplot(aes(x = År, y = Antal, color = Kön)) + 
  geom_line(linewidth = 1) +
  geom_point_interactive(aes(tooltip = Antal),
                         size = 2.5) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_x_continuous(guide = guide_axis(n.dodge = 1), breaks = årtal) +
  scale_y_continuous(limits = c(0,NA)) +
  labs(title = "Antal respondenter per år",
       subtitle = "Fördelat på kön")

girafe(ggobj = responsesGender)

```
### Fördelat på årskurs
```{r}
responsesARSKURS <- df %>% 
  filter(Kommun == fokusKommun,
         !Kön == "<NA>") %>% 
  rename(År = ar,
         Årskurs = ARSKURS) %>% 
  group_by(År,Årskurs) %>% 
  summarise(Antal = n()) %>% 
  ggplot(aes(x = År, y = Antal, color = Årskurs)) + 
  geom_line(linewidth = 1) +
  geom_point_interactive(aes(tooltip = Antal),
                         size = 2.5) +
  #scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_x_continuous(guide = guide_axis(n.dodge = 1), breaks = årtal) +
  scale_y_continuous(limits = c(0,NA)) +
  labs(title = "Antal respondenter per år",
       subtitle = "Fördelat på årskurs")  

girafe(ggobj = responsesARSKURS)

```
### Otillräckliga svar
Det krävs svar på minst 5 frågor inom ett index för att ett indexvärde ska beräknas. Här redovisas hur stor andel av de som svarat på Stockholmsenkäten som har 0-4 frågor besvarade inom varje index.
```{r}
otillr <- df.risk %>%
  filter(is.na(riskLevel)) %>%
  filter(Kommun == fokusKommun) %>%
  ggplot(aes(x = År, y = Andel, group = Index, color = Index)) +
  geom_line(linewidth = 0.8) +
  geom_point_interactive(aes(tooltip = Andel),
                         size = 2.5) +
  ylab("Andel i %")
girafe(ggobj = otillr)

```
### Tabeller
```{r}
#| layout-ncol: 2
#| include: true
#| 

df %>% 
  filter(Kommun == fokusKommun,
         !Kön == "<NA>") %>% 
  rename(År = ar,
         Årskurs = ARSKURS) %>% 
  group_by(År,Kön) %>% 
  summarise(`Antal respondenter` = n()) %>% 
  gt(.,
   groupname_col = "År") %>% 
  gt_theme_espn() %>% 
  tab_options(table.font.name = "Lato",
              heading.align = "left") %>% 
  cols_align(align = "right")

df %>% 
  filter(Kommun == fokusKommun,
         !Kön == "<NA>") %>% 
  rename(År = ar,
         Årskurs = ARSKURS) %>% 
  group_by(År,Kön,Årskurs) %>% 
  summarise(`Antal respondenter` = n()) %>% 
  gt(.,
   groupname_col = c("År","Årskurs")) %>% 
  gt_theme_espn() %>% 
  tab_options(table.font.name = "Lato",
              heading.align = "left") %>% 
  cols_align(align = "right",
             columns = "Kön")
```
:::

## Samtliga riskfaktorer, per år
```{r}
DIDsnirkel <- function(årtal) {
  year <- årtal
  df.risk %>%
    #filter(!riskLevel == "NA") %>%
    filter(Kommun == fokusKommun) %>%
    filter(År == year) %>%
    filter(!Index %in% c("Välbefinnande", "Positiv skolanknytning")) %>%
    mutate(riskLevel = car::recode(riskLevel,"NA='För få svar';
                                   'Medelhög risk'='Något förhöjd risk';
                                   'Hög risk'='Förhöjd risk'")) %>% 
    mutate(Risknivå = factor(riskLevel, levels = c("För få svar", "Låg risk", "Något förhöjd risk", "Förhöjd risk"))) %>%
    ggplot(aes(x = Index, y = Andel, fill = Risknivå)) +
    geom_col() +
    geom_textpath(aes(label = Index, group = Index),
                  text_only = T,
                  position = "stack",
                  hjust = 0,
                  size = 4
    ) +
    coord_polar(theta = "y") +
    scale_fill_manual(values = lighten(c("lightgrey","#009E73", "#F0E442", "#D55E00"),
                                       amount = 0.1, space = "HLS")) +
    theme_bw() +
    scale_x_discrete(
      expand = expansion(add = c(3, 0)),
      limits = rev,
      labels = NULL
    ) +
    scale_y_continuous(
      breaks = seq(0, 90, 10),
      labels = paste0(seq(0, 90, 10), "%"),
      limits = c(0, 100)
    ) +
    labs(title = paste0(fokusKommun, " - ", year)) +
    geom_texthline(
      yintercept = 10, color = "black",
      linetype = 2, size = 2.5, alpha = 0.6,
      label = "Förhöjd risk",
      hjust = 0.05
    ) +
    geom_texthline(
      yintercept = 25, color = RISEprimRed,
      linetype = 2, size = 2.5, alpha = 0.6,
      label = "Något förhöjd risk",
      hjust = 0.15
    ) +
    theme(
      axis.text.x = element_text(size = ax.size, family = "sans"),
      axis.text.y = element_text(size = ax.size, family = "sans"),
      title = element_text(size = title.size),
      legend.text = element_text(size = legend.size),
      strip.text.x = element_text(size = stript.size),
      panel.spacing = unit(pandist, "cm", data = NULL)
    ) +
    xlab("") +
    ylab("")
}
```

:::: column-page-inset-left
::: panel-tabset
### 2022
```{r}
DIDsnirkel("2022")
```
### 2020
```{r}
DIDsnirkel("2020")
```
### 2018
```{r}
DIDsnirkel("2018")
```
### 2016
```{r}
DIDsnirkel("2016")
```
### 2014
```{r}
#DIDsnirkel("2014")
```
### Samlade
```{r}

# snirkelplot
#years <- c(2012,2014,2016,2018,2020,2022)

df.risk %>%
  #filter(!riskLevel == "NA") %>%
  filter(Kommun == fokusKommun) %>%
  filter(År %in% years) %>%
  filter(!Index %in% c("Välbefinnande", "Positiv skolanknytning")) %>%
    mutate(riskLevel = car::recode(riskLevel,"NA='För få svar';
                                   'Medelhög risk'='Något förhöjd risk';
                                   'Hög risk'='Förhöjd risk'")) %>% 
    mutate(Risknivå = factor(riskLevel, levels = c("För få svar", "Låg risk", "Något förhöjd risk", "Förhöjd risk"))) %>% # remove NA?
    ggplot(aes(x = Index, y = Andel, fill = Risknivå)) +
    geom_col() +
    geom_textpath(aes(label = Index, group = Index),
                  text_only = T,
                  position = "stack",
                  hjust = 0,
                  size = 2
    ) +
    coord_polar(theta = "y") +
    scale_fill_manual(values = lighten(c("lightgrey","#009E73", "#F0E442", "#D55E00"),
                                       amount = 0.1, space = "HLS")) +
  theme_bw() +
  scale_x_discrete(
    expand = expansion(add = c(3, 0)),
    limits = rev,
    labels = NULL
  ) +
  scale_y_continuous(
    breaks = seq(0, 90, 10),
    labels = paste0(seq(0, 90, 10), "%"),
    limits = c(0, 100)
  ) +
  labs(title = paste0(fokusKommun)) +
  geom_texthline(
    yintercept = 10, color = "black",
    linetype = 2, size = 1, alpha = 0.6,
    label = "Hög risk",
    hjust = 0.05
  ) +
  geom_texthline(
    yintercept = 30, color = RISEprimRed,
    linetype = 2, size = 1, alpha = 0.6,
    label = "Medelhög risk",
    hjust = 0.15
  ) +
  theme(
    axis.text.x = element_text(size = ax.size-3, family = "sans"),
    axis.text.y = element_text(size = ax.size-3, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = stript.size),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  xlab("") +
  ylab("") +
  facet_wrap(~År)
```
:::
::::

## Riskfaktorer över tid, uppdelat på kön
```{r}
DIDareaPlot <- function(faktor) {
  plotFaktor <- faktor
  df.plot <- df %>%
    filter(Kommun == fokusKommun) %>%
    mutate(
      Risknivå = case_when(
        .data[[plotFaktor]] < rslimits |>
          select(plotFaktor) |>
          slice(1) |>
          pull() ~ "Låg risk",
        .data[[plotFaktor]] >= rslimits |>
          select(plotFaktor) |>
          slice(1) |>
          pull() &
          .data[[plotFaktor]] < rslimits |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "Något förhöjd risk",
        .data[[plotFaktor]] >= rslimits |>
          select(plotFaktor) |>
          slice(2) |>
          pull() ~ "Förhöjd risk",
        TRUE ~ "Otillräckliga svar"
      )
    )

  df.plot %>%
    filter(Kön %in% c("Pojke", "Flicka")) %>%
    # filter(ar %in% input$years0) %>% # allow selection of span of years?
    mutate(Risknivå = factor(Risknivå, levels = c("Förhöjd risk", "Något förhöjd risk", "Låg risk", "Otillräckliga svar"))) %>%
    group_by(ar, Kön) %>%
    count(Risknivå, .drop = FALSE) %>%
    mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>%
    ggplot(aes(x = ar, y = Andel)) +
    geom_area(aes(fill = Risknivå),
      position = "stack",
      alpha = 0.85
    ) +
    scale_fill_manual(values = c("#D55E00", "#F0E442", "#009E73", "lightgrey")) +
    #scale_color_manual(values = c("#D55E00", "#F0E442", "#009E73", "lightgrey")) +
    geom_hline(yintercept = 90, color = "black", linetype = 2, linewidth = 0.66) +
    geom_hline(yintercept = 75, color = RISEprimRed, linetype = 2, linewidth = 0.66) +
    scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100)) +
    scale_x_continuous(breaks = årtal, guide = guide_axis(n.dodge = 2)) +
    xlab("Årtal") +
    ylab("Andel i %") +
    theme(
      axis.text.x = element_text(size = ax.size, family = "sans"),
      axis.text.y = element_text(size = ax.size, family = "sans"),
      title = element_text(size = title.size),
      legend.text = element_text(size = legend.size),
      strip.text.x = element_text(size = 14),
      panel.spacing = unit(pandist, "cm", data = NULL)
    ) +
    labs(
      title = paste0(plotFaktor, " - ", fokusKommun),
      subtitle = "Uppdelat på kön",
      caption = str_wrap("Svart streckad linje = referensvärde för 10% med högst risk. 
      Röd linje = referensvärde för 25% med högst risk",
        width = 60
      )
    ) +
    facet_wrap(~Kön)
}
```

::: panel-tabset
### Utagerande
```{r}
DIDareaPlot("Utagerande")
```
### Psykiska/psykosomatiska besvär
```{r}
DIDareaPlot("Psykiska/ psykosomatiska besvär")
```
### Föräldraskap
```{r}
DIDareaPlot("Föräldraskap")
```
### Vantrivsel i skolan
```{r}
DIDareaPlot("Vantrivsel i skolan")
```
### Närsamhälle
```{r}
DIDareaPlot("Närsamhälle")
```
:::

## Riskfaktorer över tid, uppdelat på årskurs

```{r}
#| include: false
### Tabell psykiska/psykosomatiska besvär åk 9

  plotFaktor <- "Psykiska/ psykosomatiska besvär"
  df.plot <- df %>%
    filter(Kommun == fokusKommun) %>%
    mutate(
      Risknivå = case_when(
        .data[[plotFaktor]] < rslimits |>
          select(plotFaktor) |>
          slice(1) |>
          pull() ~ "Låg risk",
        .data[[plotFaktor]] >= rslimits |>
          select(plotFaktor) |>
          slice(1) |>
          pull() &
          .data[[plotFaktor]] < rslimits |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "Något förhöjd risk",
        .data[[plotFaktor]] >= rslimits |>
          select(plotFaktor) |>
          slice(2) |>
          pull() ~ "Förhöjd risk",
        TRUE ~ "Otillräckliga svar"
      )
    )

## Table for all years and ARSKURS
#   df.plot %>%
#     filter(Kön %in% c("Pojke", "Flicka")) %>%
#     #filter(ar %in% c()) %>% # allow selection of span of years?
#     mutate(Risknivå = factor(Risknivå, levels = c("Förhöjd risk", "Något förhöjd risk", "Låg risk", "Otillräckliga svar"))) %>%
#     group_by(ar, Kön, ARSKURS) %>%
#     count(Risknivå, .drop = FALSE) %>%
#     mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>% 
#     rename(Antal = n) %>% 
#     gt(.,
#    groupname_col = c("ar","ARSKURS","Kön")) %>% 
#   gt_theme_espn() %>% 
#   tab_options(table.font.name = "Lato",
#               container.width = 500,
#               heading.align = "left") %>% 
#   cols_align(align = "right")
  
    df.plot %>%
    filter(Kön %in% c("Pojke", "Flicka")) %>%
    filter(ar %in% c(2010,2016,2020,2022)) %>% # allow selection of span of years?
    filter(ARSKURS == "Åk 9") %>% 
    mutate(Risknivå = factor(Risknivå, levels = c("Förhöjd risk", "Något förhöjd risk", "Låg risk", "Otillräckliga svar"))) %>%
    group_by(ar, Kön) %>%
    count(Risknivå, .drop = FALSE) %>%
    mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>% 
    rename(Antal = n) %>% 
    gt(.,
   groupname_col = c("ar","Kön")) %>% 
  gt_theme_espn() %>% 
  tab_options(table.font.name = "Lato",
              container.width = 500,
              heading.align = "left") %>% 
  cols_align(align = "right")
  
```



## Välbefinnande

::: panel-tabset
### Grupperat
```{r}

plotFaktor <- "Välbefinnande"

df.plot <- df %>%
      filter(Kommun == fokusKommun) %>%
      mutate(
        Risknivå = case_when(
          .data[[plotFaktor]] < rslimits.prot |>
            select(plotFaktor) |>
            slice(1) |>
            pull() ~ "20% lägst",
          .data[[plotFaktor]] >= rslimits.prot |>
            select(plotFaktor) |>
            slice(1) |>
            pull() &
            .data[[plotFaktor]] < rslimits.prot |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "Normal nivå",
          .data[[plotFaktor]] >= rslimits.prot |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "20% högst",
          TRUE ~ "Otillräckliga svar"
        )
      )
    
    df.plot %>%
      filter(Kön %in% c("Flicka","Pojke")) %>%
      #filter(!Risknivå == "Otillräckliga svar") %>% 
      group_by(ar, Kön) %>%
      count(Risknivå) %>%
      mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>%
      mutate(Grupp = factor(Risknivå, levels = c("20% högst", "Normal nivå", 
                                                    "20% lägst","Otillräckliga svar"))) %>%
      ungroup() %>% 
      ggplot(aes(x = ar, y = Andel)) +
      geom_area(aes(color = Grupp, fill = Grupp), position = "stack") +
      scale_fill_manual(values = c("#00C18D","#F1E755","#F36B00","lightgrey")) +
      scale_color_manual(values = c("#00C18D","#F1E755","#F36B00","lightgrey")) +
      #geom_hline(yintercept = 80, color = "black", linetype = 2, linewidth = 0.66) +
      #geom_hline(yintercept = 20, color = RISEprimRed, linetype = 2, linewidth = 0.66) +
      scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100)) +
      #scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
      xlab("Årtal") +
      ylab("Andel i %") +
      theme(
        axis.text.x = element_text(size = ax.size, family = "sans"),
        axis.text.y = element_text(size = ax.size, family = "sans"),
        title = element_text(size = title.size),
        legend.text = element_text(size = legend.size),
        strip.text.x = element_text(size = stript.size),
        panel.spacing = unit(pandist, "cm", data = NULL)
      ) +
      labs(
        title = paste0(plotFaktor, " - ", fokusKommun),
        subtitle = "Uppdelat på kön",
        caption = str_wrap("Grönt fält = Andel som överstiger referensvärde för 20% med högst välbefinnande.\nRött fält indikerar andel som understiger referensvärde för 20% med lägst välbefinnande.")
      ) +
      facet_wrap(~Kön)
```
### Kontinuerlig skala
```{r}

plotFaktor <- "Välbefinnande"

df.plot <- df %>%
      filter(Kommun == fokusKommun) %>%
      select(plotFaktor, Kommun, ar) %>%
      rename(RSfaktor = plotFaktor,
             År = ar)

    ggplot(df.plot, aes(x = RSfaktor, y = factor(År), fill = År)) + # make plot, with fill color by year
      stat_slab(aes(fill_ramp = after_stat(level), fill = År),
        side = "right", show.legend = F,
        scale = 0.6, # defines the height that a slab can reach
        position = position_dodge(width = .6), # distance between elements for dodging
        .width = c(.50, .90, 1)
      ) + 
      stat_summary(
        fun.data = "mean_cl_normal",
        show.legend = F,
        size = .4,
        position = position_dodge2nudge(x = .05, width = .8)
      ) +
      theme(
        axis.text.x = element_text(size = ax.size, family = "sans"),
        axis.text.y = element_text(size = ax.size, family = "sans"),
        title = element_text(size = title.size),
      ) +
      xlab("") +
      ylab("") +
      labs(
        title = paste0(plotFaktor),
        caption = str_wrap("Pricken visar medelvärde. Fältet i mitten visar 50% av respondenterna, medan nästa fält visar 90% av respondenterna.")
      )
```
### Box- & violinplots
```{r}
df.plot <- df %>%
      #filter(ar == input$year2) %>% # filter the year selected
      # filter(Kön %in% input$gender) %>%  # and gender(s) selected
      filter(Kommun == fokusKommun,
             !Kön == "<NA>") %>%
      select(plotFaktor, Kommun, ar, Kön) %>%
      rename(RSfaktor = plotFaktor,
             År = ar)
ggplot(df.plot, aes(y = RSfaktor, x = factor(År))) +
  geom_violin(alpha = 1, aes(fill = Kön)) +
  geom_boxplot(alpha = 0.4, width = 0.6, outlier.shape = NA, notch = TRUE) +
  scale_fill_brewer(type = "qual", palette = "Dark2") +
  xlab("Årtal") +
  ylab("Välbefinnande")
```
:::

## Positiv skolanknytning över tid

::: panel-tabset
### Grupperat
```{r}

plotFaktor <- "Positiv skolanknytning"

df.plot <- df %>%
      filter(Kommun == fokusKommun) %>%
      mutate(
        Risknivå = case_when(
          .data[[plotFaktor]] < rslimits.prot |>
            select(plotFaktor) |>
            slice(1) |>
            pull() ~ "Lågt skydd",
          .data[[plotFaktor]] >= rslimits.prot |>
            select(plotFaktor) |>
            slice(1) |>
            pull() &
            .data[[plotFaktor]] < rslimits.prot |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "Neutral",
          .data[[plotFaktor]] >= rslimits.prot |>
            select(plotFaktor) |>
            slice(2) |>
            pull() ~ "Högt skydd",
          TRUE ~ "Otillräckliga svar"
        )
      )
    
    df.plot %>%
      filter(Kön %in% c("Flicka","Pojke")) %>%
      #filter(!Risknivå == "Otillräckliga svar") %>% 
      group_by(ar, Kön) %>%
      count(Risknivå) %>%
      mutate(Andel = (100 * n / sum(n)) %>% round(digits = 1)) %>%
      mutate(Grupp = factor(Risknivå, levels = c("Högt skydd", "Neutral", 
                                                    "Lågt skydd","Otillräckliga svar"))) %>%
      ungroup() %>% 
      ggplot(aes(x = ar, y = Andel)) +
      geom_area(aes(color = Grupp, fill = Grupp), position = "stack") +
      scale_fill_manual(values = c("#00C18D","#F1E755","#F36B00","lightgrey")) +
      scale_color_manual(values = c("#00C18D","#F1E755","#F36B00","lightgrey")) +
      #geom_hline(yintercept = 80, color = "black", linetype = 2, linewidth = 0.66) +
      #geom_hline(yintercept = 20, color = RISEprimRed, linetype = 2, linewidth = 0.66) +
      scale_y_continuous(breaks = c(0, 20, 40, 60, 80, 100)) +
      #scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
      xlab("Årtal") +
      ylab("Andel i %") +
      theme(
        axis.text.x = element_text(size = ax.size, family = "sans"),
        axis.text.y = element_text(size = ax.size, family = "sans"),
        title = element_text(size = title.size),
        legend.text = element_text(size = legend.size),
        strip.text.x = element_text(size = stript.size),
        panel.spacing = unit(pandist, "cm", data = NULL)
      ) +
      labs(
        title = paste0(plotFaktor, " - ", fokusKommun),
        subtitle = "Uppdelat på kön",
        caption = str_wrap("Grönt fält indikerar andel som överstiger referensvärde för 20% med högst skydd.\nRött fält  indikerar andel som understiger referensvärde för 20% med lägst skydd.")
      ) +
      facet_wrap(~Kön)
```
### Kontinuerlig skala
```{r}

plotFaktor <- "Positiv skolanknytning"

df.plot <- df %>%
      filter(Kommun == fokusKommun) %>%
      select(plotFaktor, Kommun, ar) %>%
      rename(RSfaktor = plotFaktor,
             År = ar)

    ggplot(df.plot, aes(x = RSfaktor, y = factor(År), fill = År)) + # make plot, with fill color by year
      stat_slab(aes(fill_ramp = after_stat(level), fill = År),
        side = "right", show.legend = F,
        scale = 0.6, # defines the height that a slab can reach
        position = position_dodge(width = .6), # distance between elements for dodging
        .width = c(.50, .90, 1)
      ) + 
      stat_summary(
        fun.data = "mean_cl_normal",
        show.legend = F,
        size = .4,
        position = position_dodge2nudge(x = .05, width = .8)
      ) +
      theme(
        axis.text.x = element_text(size = ax.size, family = "sans"),
        axis.text.y = element_text(size = ax.size, family = "sans"),
        title = element_text(size = title.size),
      ) +
      xlab("") +
      ylab("") +
      labs(
        title = paste0(plotFaktor),
        caption = str_wrap("Pricken visar medelvärde. Fältet i mitten visar 50% av respondenterna, medan nästa fält visar 90% av respondenterna.")
      )
```
### Box- & violinplots
```{r}
df.plot <- df %>%
      #filter(ar == input$year2) %>% # filter the year selected
      # filter(Kön %in% input$gender) %>%  # and gender(s) selected
      filter(Kommun == fokusKommun,
             !Kön == "<NA>") %>%
      select(plotFaktor, Kommun, ar, Kön) %>%
      rename(RSfaktor = plotFaktor,
             År = ar)
ggplot(df.plot, aes(y = RSfaktor, x = factor(År))) +
  geom_violin(alpha = 1, aes(fill = Kön)) +
  geom_boxplot(alpha = 0.4, width = 0.6, outlier.shape = NA, notch = TRUE) +
  scale_fill_brewer(type = "qual", palette = "Dark2") +
  xlab("Årtal") +
  ylab("Välbefinnande")
```
:::

## KOLADA
```{r}
KOLADA <- read_parquet("../../data/2023-01-10_koladaData.parquet")

# which KPI's to remove?
removed.kpi <- c("N17473","N15613","N15643","N17620")
# set which are available in app
kpiChoices <- KOLADA %>% 
  filter(!kpi %in% removed.kpi) %>% 
  arrange(kpi) %>% 
  distinct(KPI) %>% 
  pull()

```


::: panel-tabset
### Förskola
```{r}

df.kolada <- KOLADA %>% 
  filter(Kön == "Alla") %>% 
  filter(Kommun %in% jmfKommun) %>% 
  filter(KPI %in% c("Barn 3-5 år inskrivna i förskola, andel (%)",
                    "Heltidstjänster i förskolan med förskollärarexamen, lägeskommun, andel (%)")
  )

ggplot(df.kolada,aes(x = År, y = Andel, group = Kommun, color = Kommun)) +
  geom_line(alpha = 0.5, 
            linewidth = 0.5) +
  geom_point(alpha = 0.5, 
             size = 1.2) +
  geom_line(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = stript.size),
    panel.spacing = unit(0.5, "cm", data = NULL)
  ) +
  facet_wrap(~KPI,
             ncol = 4,
             scales = "free",
             labeller = labeller(KPI = label_wrap_gen(25)))
```
### Grundskola
```{r}
#| fig-height: 8
df.kolada <- KOLADA %>% 
  filter(Kön == "Alla") %>% 
  filter(Kommun %in% jmfKommun) %>% 
  filter(KPI %in% c("Lärare med pedagogisk högskoleexamen i grundskola åk 1-9, lägeskommun, andel (%)",
                    "Lärare (heltidstjänster) med lärarlegitimation och behörighet i minst ett ämne i grundskola åk 1-9, lägeskommun, andel (%)",
                    "Elever i åk 9 som är behöriga till yrkesprogram, hemkommun, andel (%)")
  )

ggplot(df.kolada,aes(x = År, y = Andel, group = Kommun, color = Kommun)) +
  geom_line(alpha = 0.5, linewidth = 0.5) +
  geom_point(alpha = 0.5, size = 1.2) +
  geom_line(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = stript.size),
    panel.spacing = unit(0.5, "cm", data = NULL)
  ) +
  ylab("Andel i %") +
  xlab("") +
  facet_wrap(~KPI,
             ncol = 2,
             nrow = 2,
             scales = "free",
             labeller = labeller(KPI = label_wrap_gen(22)))
```
### Gymnasie
```{r}
#| fig-height: 8
df.kolada <- KOLADA %>% 
  filter(Kön == "Alla") %>% 
  filter(Kommun %in% jmfKommun) %>% 
  filter(KPI %in% c("Lärare med pedagogisk högskoleexamen i gymnasieskola, lägeskommun, andel (%)",
                    "Gymnasieelever som uppnått grundläggande behörighet till universitet och högskola inom 4 år, hemkommun, andel (%)",
                    "Gymnasieelever med indraget studiestöd pga. ogiltig frånvaro, hemkommun, andel (%)")
  )

ggplot(df.kolada,aes(x = År, y = Andel, group = Kommun, color = Kommun)) +
  geom_line(alpha = 0.5, linewidth = 0.5) +
  geom_point(alpha = 0.5, size = 1.2) +
  geom_line(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.kolada, Kommun == fokusKommun), alpha = 1) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = stript.size),
    panel.spacing = unit(0.5, "cm", data = NULL)
  ) +
  ylab("Andel i %") +
  xlab("") +
  facet_wrap(~KPI,
             ncol = 2,
             nrow = 2,
             scales = "free",
             labeller = labeller(KPI = label_wrap_gen(22)))
```
:::

## Jämförelser med andra kommuner

### Antal svar över tid
```{r}
responsesKommuner <- df %>% 
  filter(Kommun %in% jmfKommun,
         !Kön == "<NA>") %>% 
  rename(År = ar,
         Årskurs = ARSKURS) %>% 
  group_by(År,Kommun) %>% 
  summarise(Antal = n()) %>% 
  ggplot(aes(x = År, y = Antal, group = Kommun, color = Kommun)) + 
  geom_line(linewidth = 1) +
  geom_point_interactive(aes(tooltip = Antal),
                         size = 2.5) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  scale_x_continuous(guide = guide_axis(n.dodge = 1), breaks = årtal) +
  scale_y_continuous(limits = c(0,2000)) +
  labs(title = "Antal respondenter per år",
       subtitle = "Fördelat på kommun")

girafe(ggobj = responsesKommuner)

```


### Riskfaktorer
```{r}
DIDradarPlot <- function(årtal){
  year <- årtal
  df.plot<-sums.index %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Faktor %in% rfactors) %>% 
  filter(Kön %in% c("Flicka","Pojke")) %>%
  filter(År == year)

ggplot(df.plot,aes(x = Faktor, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  see::coord_radar(theta = "x", start = 3, clip = "off") +
  scale_y_continuous(limits = c(-3, NA), expand = c(0,0, 0, 0)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_blank(),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = 14),
    panel.background = element_rect(fill = 'white'),
    panel.grid.major = element_line(color = 'grey', linetype = 'dotted'),
    panel.grid.minor = element_line(color = 'grey', linewidth = 2),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = paste0("Riskfaktorer ",year),
       subtitle = "Högre värde = större risk",
       y = "", x = "") +
  facet_wrap(~Kön)
}
```

::: panel-tabset
#### 2022
```{r}
DIDradarPlot("2022")
```
#### 2020
```{r}
year <- "2020"
df.plot<-sums.index %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Faktor %in% rfactors) %>% 
  filter(Kön %in% c("Flicka","Pojke")) %>%
  filter(År == year)

ggplot(df.plot,aes(x = Faktor, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  see::coord_radar(theta = "x", start = 3, clip = "off") +
  scale_y_continuous(limits = c(-3, NA), expand = c(0,0, 0, 0)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_blank(),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = 14),
    panel.background = element_rect(fill = 'white'),
    panel.grid.major = element_line(color = 'grey', linetype = 'dotted'),
    panel.grid.minor = element_line(color = 'grey', linewidth = 2),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = paste0("Riskfaktorer ",year),
       subtitle = "Högre värde = större risk",
       y = "", x = "") +
  facet_wrap(~Kön)
```
#### 2018
```{r}
year <- "2018"
df.plot<-sums.index %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Faktor %in% rfactors) %>% 
  filter(Kön %in% c("Flicka","Pojke")) %>%
  filter(År == year)

ggplot(df.plot,aes(x = Faktor, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  see::coord_radar(theta = "x", start = 3, clip = "off") +
  scale_y_continuous(limits = c(-3, NA), expand = c(0,0, 0, 0)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_blank(),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = 14),
    panel.background = element_rect(fill = 'white'),
    panel.grid.major = element_line(color = 'grey', linetype = 'dotted'),
    panel.grid.minor = element_line(color = 'grey', linewidth = 2),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = paste0("Riskfaktorer ",year),
       subtitle = "Högre värde = större risk",
       y = "", x = "") +
  facet_wrap(~Kön)
```
#### 2016
```{r}
year <- "2016"
df.plot<-sums.index %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Faktor %in% rfactors) %>% 
  filter(Kön %in% c("Flicka","Pojke")) %>%
  filter(År == year)

ggplot(df.plot,aes(x = Faktor, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  see::coord_radar(theta = "x", start = 3, clip = "off") +
  scale_y_continuous(limits = c(-3, NA), expand = c(0,0, 0, 0)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_blank(),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = 14),
    panel.background = element_rect(fill = 'white'),
    panel.grid.major = element_line(color = 'grey', linetype = 'dotted'),
    panel.grid.minor = element_line(color = 'grey', linewidth = 2),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = paste0("Riskfaktorer ",year),
       subtitle = "Högre värde = större risk",
       y = "", x = "") +
  facet_wrap(~Kön)
```
:::

### Medelvärden över tid
```{r}
DIDmedelSD <- function(faktor, xlim = c(-2,2)) {
  plotFaktor <- faktor
  df.plot <- sums.index %>%
  filter(Faktor == plotFaktor) %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Kön == "Flickor och pojkar") %>%
  filter(!År < 2006) %>% 
  mutate(År = as.factor(År))
  
  ggplot(df.plot, aes(x = År, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_ribbon(aes(ymin = sd.lo, ymax = sd.hi),
              alpha = 0.1, linetype = 0
  ) +
  scale_y_continuous(limits = xlim) +
  scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = "Medelvärde över tid", subtitle = "Skuggat fält indikerar en standardavvikelse (~ 68%)") +
  xlab("Årtal") +
  ylab(paste0(plotFaktor))
}
```

::: panel-tabset
#### Utagerande
```{r}
DIDmedelSD("Utagerande")
```
#### Psykiska/psykosomatiska besvär
```{r}
DIDmedelSD("Psykiska/ psykosomatiska besvär")
```
#### Föräldraskap
```{r}
DIDmedelSD("Föräldraskap")
```
#### Vantrivsel i skolan
```{r}
DIDmedelSD("Vantrivsel i skolan")
```
#### Närsamhälle
```{r}
DIDmedelSD("Närsamhälle", xlim = c(-3,2))
```
:::

```{r}
#| eval: false

# same but facet_wrapped for gender

plotFaktor <- "Psykiska/ psykosomatiska besvär"
df.plot <- sums.index %>%
  filter(Faktor == plotFaktor) %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(!Kön == "Flickor och pojkar") %>%
  filter(!År < 2006) %>% 
  mutate(År = as.factor(År))

ggplot(df.plot, aes(x = År, y = Medel, group = Kommun, color = Kommun, fill = Kommun)) + # make plot, with area color
  geom_line(linewidth = 0.9,
            alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.7) +
  geom_line(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_point(data = filter(df.plot, Kommun == fokusKommun), alpha = 1) +
  geom_ribbon(aes(ymin = sd.lo, ymax = sd.hi),
              alpha = 0.1, linetype = 0
  ) +
  scale_y_continuous(limits = c(-2,2)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 1)) +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  labs(title = "Medelvärde över tid", subtitle = "Skuggat fält indikerar en standardavvikelse (~ 68%)") +
  xlab("Årtal") +
  ylab(paste0(plotFaktor)) +
  facet_wrap(~Kön)
```


### Högrisk över tid

```{r}
DIDline90 <- function(faktor){
  plotFaktor <- faktor
df.plot <- sums.index %>%
  filter(Faktor == plotFaktor) %>%
  filter(Kommun %in% jmfKommun) %>%
  filter(Kön %in% c("Flicka", "Pojke")) %>%
  filter(!År < 2006) %>% 
  mutate(År = as.factor(År))

ggplot(df.plot, aes(x = År, y = n.90, group = Kön, color = Kön, tooltip = n, data_id = n)) + # make plot, with area color
  geom_line(linewidth = 0.9) +
  geom_point(size = 2) +
  scale_y_continuous(limits = c(0, 30)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  theme(
    axis.text.x = element_text(size = ax.size, family = "sans"),
    axis.text.y = element_text(size = ax.size, family = "sans"),
    title = element_text(size = title.size),
    legend.text = element_text(size = legend.size),
    strip.text.x = element_text(size = stript.size),
    panel.spacing = unit(pandist, "cm", data = NULL)
  ) +
  #geom_hline(yintercept = 10, color = RISEprimRed, linetype = 2, linewidth = 0.4) +
  ggtitle("Procent över percentil 90, per år") +
  xlab("") +
  ylab(paste0(plotFaktor)) +
  facet_wrap(~Kommun, labeller = labeller(Kommun = label_wrap_gen(12)))
}
```

::: panel-tabset
#### Utagerande
```{r}
DIDline90("Utagerande")
```
#### Psykiska/psykosomatiska besvär
```{r}
DIDline90("Psykiska/ psykosomatiska besvär")
```
#### Föräldraskap
```{r}
DIDline90("Föräldraskap")
```
#### Vantrivsel i skolan
```{r}
DIDline90("Vantrivsel i skolan")
```
#### Närsamhälle
```{r}
DIDline90("Närsamhälle")
```
:::

